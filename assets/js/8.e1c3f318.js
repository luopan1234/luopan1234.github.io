(window.webpackJsonp=window.webpackJsonp||[]).push([[8],{269:function(t,s,a){"use strict";a.r(s);var n=a(38),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h2",{attrs:{id:"接入-typescript"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#接入-typescript","aria-hidden":"true"}},[t._v("#")]),t._v(" 接入 TypeScript")]),t._v(" "),a("p",[t._v("在给 vemojs 做完各种测试之后，导师很快提出了新的要求，给 "),a("a",{attrs:{href:"https://github.com/TencentCloudBase/cloud-base-cli",target:"_blank",rel:"noopener noreferrer"}},[t._v("clousebase-cli"),a("OutboundLink")],1),t._v("  编写测试用例。有个问题摆在眼前：它是用 typescript 编写，所以需要配置相关环境。")]),t._v(" "),a("p",[t._v("好吧，不说废话了，直接上干货。")]),t._v(" "),a("p",[a("code",[t._v("jest.config.js")]),t._v("  配置内容如下，解释在注释里面：")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[t._v("module"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("exports "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  roots"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"<rootDir>/test"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 测试目录")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  transform"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"^.+\\\\.tsx?$"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ts-jest"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 匹配 .ts 或者 .tsx 结尾的文件")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  collectCoverage"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 统计覆盖率")]),t._v("\n  testEnvironment"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"node"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 测试环境")]),t._v("\n  setupFilesAfterEnv"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"<rootDir>/jest.setup.js"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 之后再说")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 不算入覆盖率的文件夹")]),t._v("\n  coveragePathIgnorePatterns"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"<rootDir>/node_modules/"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"<rootDir>/test/"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"<rootDir>/deps/"')]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("上面有个 "),a("code",[t._v("jest.setup.js")]),t._v(" ，它的内容是： "),a("code",[t._v("jest.setTimeout(60000)")]),t._v(" 。因为有时候网速很慢，api 请求延时会很高，所以这个就是设置请求超时时间为 1 分钟。")]),t._v(" "),a("p",[t._v("最坑的一点是，除了 "),a("code",[t._v("jest")]),t._v("  的配置文件，还要修改 typescript 对应的文件， "),a("code",[t._v("tsconfig.json")]),t._v("  内容如下。types 中必须添加 "),a("code",[t._v("jest")]),t._v(" ，否则找不到 "),a("code",[t._v("expect")]),t._v(" 、 "),a("code",[t._v("describe")]),t._v("  等变量的定义。")]),t._v(" "),a("div",{staticClass:"language-json extra-class"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"compilerOptions"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"types"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"node"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"jest"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[a("strong",[t._v("总之，cloudbase-cli 的测试用例写的比 vemo 好，哈哈")])]),t._v(" "),a("h2",{attrs:{id:"集成测试"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#集成测试","aria-hidden":"true"}},[t._v("#")]),t._v(" 集成测试")]),t._v(" "),a("p",[t._v("持续继承测试我们借助  "),a("a",{attrs:{href:"https://travis-ci.org/",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://travis-ci.org/"),a("OutboundLink")],1),t._v("  这个平台，它的工作流程非常简单：")]),t._v(" "),a("ol",[a("li",[t._v("在它平台上授权 github 仓库的权限，github 仓库下配置  .travis.yml 文件")]),t._v(" "),a("li",[t._v("每次 commit 推上新代码的时候，travis-ci 平台都会接收到通知")]),t._v(" "),a("li",[t._v("读取 .travis.yml 文件，"),a("strong",[t._v("然后创建一个虚拟环境")]),t._v("，来跑配置好的脚本（比如启动测试脚本）")])]),t._v(" "),a("p",[t._v("它的优点在于，测试代码推上去后，直接在账号下的控制台就能看到测试结果，非常方便；而且可以在配置文件中，指明多个测试环境，比如 node 有 6、8、10，让测试更具有信服力。")]),t._v(" "),a("p",[t._v("我把样例代码放在了 "),a("a",{attrs:{href:"https://github.com/dongyuanxin/try-travis-ci",target:"_blank",rel:"noopener noreferrer"}},[t._v("try-travis-ci"),a("OutboundLink")],1),t._v("  仓库下，可以跑一下看看。下面是 .travis.yml 文件内容。")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("sudo")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("false")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("language")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"node_js"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("node_js")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"8"')]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"10"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("install")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" npm install\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" npm run test\n")])])]),a("p",[t._v("看见了吗，就是下面贼酷炫的界面，登陆用户就能看到了："),a("br"),a("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2019/png/233327/1556960049220-d204d334-21fb-4963-9095-e37d1600ac4b.png#align=left&display=inline&height=784&name=image.png&originHeight=980&originWidth=1908&size=147774&status=done&width=1526.4",alt:"image.png"}})]),t._v(" "),a("h2",{attrs:{id:"覆盖率统计"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#覆盖率统计","aria-hidden":"true"}},[t._v("#")]),t._v(" 覆盖率统计")]),t._v(" "),a("p",[t._v("覆盖率统计也很简单（本来以为会很难），但是要安装 "),a("code",[t._v("coveralls")]),t._v("  这个库。除此之外，还要修改一下 package.json 中的 scripts 的指令。通过管道，将结果交给 coveralls。")]),t._v(" "),a("div",{staticClass:"language-json extra-class"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"scripts"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"test"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"jest --passWithNoTests --coverage --env=node --detectOpenHandles --coverageReporters=text-lcov | coveralls"')]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("后来发现，在统计覆盖率的时候，会把覆盖的信息放在根目录下的 "),a("code",[t._v("coverage")]),t._v("  文件夹下，这些信息都是多个平台约定好的数据格式。所以各个工具间可以共同使用。")]),t._v(" "),a("p",[t._v("剩下要做的就是，登陆 coveralls.io 平台，授权 github 仓库权限。当你在 travis 平台运行上述 scripts 脚本时候，它就自动把结果扔到了 coveralls.io 平台。登陆账号，就能看到覆盖率了。")]),t._v(" "),a("h2",{attrs:{id:"参考资料"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考资料","aria-hidden":"true"}},[t._v("#")]),t._v(" 参考资料")]),t._v(" "),a("ul",[a("li",[t._v("《持续集成服务 Travis CI 教程》："),a("a",{attrs:{href:"http://www.ruanyifeng.com/blog/2017/12/travis_ci_tutorial.html?20190430165111",target:"_blank",rel:"noopener noreferrer"}},[t._v("http://www.ruanyifeng.com/blog/2017/12/travis_ci_tutorial.html?20190430165111"),a("OutboundLink")],1)]),t._v(" "),a("li",[t._v("Travis CI Document："),a("a",{attrs:{href:"https://docs.travis-ci.com/user/languages/javascript-with-nodejs/#stq=&stp=0",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://docs.travis-ci.com/user/languages/javascript-with-nodejs/#stq=&stp=0"),a("OutboundLink")],1)]),t._v(" "),a("li",[t._v("Coveralls IO JavaScript Document："),a("a",{attrs:{href:"https://docs.coveralls.io/javascript",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://docs.coveralls.io/javascript"),a("OutboundLink")],1)]),t._v(" "),a("li",[t._v("第三方库 node-coveralls："),a("a",{attrs:{href:"https://github.com/nickmerwin/node-coveralls",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://github.com/nickmerwin/node-coveralls"),a("OutboundLink")],1)])])])}),[],!1,null,null,null);s.default=e.exports}}]);